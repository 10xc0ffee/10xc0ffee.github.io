<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"0xc0ffee.xyz","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="http://0xc0ffee.xyz/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="en_US">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://0xc0ffee.xyz/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title></title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QSMDD3ZT3S"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-QSMDD3ZT3S","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title"></h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name"></p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://0xc0ffee.xyz/2025/01/09/2025/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | null">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/01/09/2025/" class="post-title-link" itemprop="url">2025</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-01-09 01:11:03" itemprop="dateCreated datePublished" datetime="2025-01-09T01:11:03-08:00">2025-01-09</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://0xc0ffee.xyz/2021/06/27/Life%20Beyond%20Distributed%20Transactions:%20An%20Apostate's%20Opinion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | null">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/06/27/Life%20Beyond%20Distributed%20Transactions:%20An%20Apostate's%20Opinion/" class="post-title-link" itemprop="url">Note of Life Beyond Distributed Transactions</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-27 10:00:00" itemprop="dateCreated datePublished" datetime="2021-06-27T10:00:00-07:00">2021-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Problem-Statement"><a href="#Problem-Statement" class="headerlink" title="Problem Statement"></a>Problem Statement</h2><p>Real-world application data grow fast. Those data will have to be repartitioned over time. Global serializability then becomes a problem. But user applications sometimes cannot get good performance by leveraging distributed transaction algorithms like 2PC (As mentioned by the Author in the year 2007).<br>So user application usually implements their way to coordinate distributed procedures that fit their system.<br>This paper discussed a model&#x2F;guideline for users to implement applications to deal with data scaling challenges, and for infra developers to build new frameworks.</p>
<h2 id="Assumption"><a href="#Assumption" class="headerlink" title="Assumption"></a>Assumption</h2><ul>
<li>Application data will grow fast. But the types of data is limited.</li>
<li>Application developers write code that is scale-agnostic.</li>
<li>The infra provides multiple disjoint scopes of transaction serializability. (e.g single machine atomicity).</li>
<li>For messaging, most applications like to use (or the infra usually provides) at-least-once delivery, but still at-most-once acceptance.<br> - Exactly once like TCP protocol works fine for temporary non-persist messages in a short-live process level. But with the need for data durability, clearly more complicated to implement (it’s like implementing a long-lived version of TCP connection. Refer to <a target="_blank" rel="noopener" href="https://web.stanford.edu/~ouster/cgi-bin/papers/rifl.pdf">RIFL</a> to see an implementation example).</li>
</ul>
<h2 id="Pattern"><a href="#Pattern" class="headerlink" title="Pattern"></a>Pattern</h2><p>With the above assumptions, the author provides the following design pattern of the scale-agnostic layer (a.k.a. application layer).</p>
<p><strong>Entity</strong></p>
<p>Addressable user data type. Atomicity happens at this level. An application can address an entity by a unique key. The author emphasizes the secondary index and primary index referenced data usually belong to different entities due to performance issues (coordination cost).</p>
<p><strong>Message</strong></p>
<p>The message is used to communicate across entities. When the update of entity A and the update of entity B are related (e.g. causality), there will be messages between A to B.<br>Messaging from entity A to entity B should be outside the transaction of either entity A or B. (For example, a user submits an order. The application updates the order table row A.<br>If that succeeds, then it needs to modify the balance table row B to charge the user. That may require a message that relates A to B. The messaging procedure should be outside transaction of A to prevent B receives the message before the transaction of A is committed).</p>
<p><strong>Activity</strong></p>
<p>The effect of a Message must be idempotent under the assumption of at-least-once-delivery. So the downstream entity needs to maintain some <strong>state</strong> to track those messages. That state is a part of an activity. An application can define more relationships (i.e. activities) between the two entities.<br>The author thinks if there is messaging between two entities, there should be an activity tracking these two entities. Under the assumption of limited user data types, the number of activities is also limited. So with this pattern, it doesn’t mean application developers have to write a lot of code.<br>Another important state of the activity is the <strong>uncertainty</strong>. For example, we are going to charge the bank account, but before we do that we don’t know how much money is in the account. That is uncertainty. The activity needs to save the state of uncertainty. The goal is to resolve the uncertainty. Considering if we are implementing a distributed transaction, normally the uncertainty is resolved along with the “locking”, either pessimistic or optimistic. At the user application level, we track them as tentative operations, confirmations (like transaction committed), and cancellations (like transaction aborted).</p>
<p><strong>Workflow</strong></p>
<p>Application business logic will be composited by different messages and related activities (which are like building blocks).</p>
<h3 id="My-Thoughts"><a href="#My-Thoughts" class="headerlink" title="My Thoughts"></a>My Thoughts</h3><p>In the year 2007, it is the time when NoSQL was rising. This paper provides a design pattern to implement complex business logic above a NoSQL database with single row atomicity. Even though, it is still complicated to implement such logic comparing to build it on a distributed RDMS. The application still needs to track&#x2F;persist the activities and their states by itself, build a state machine to react to any activities’ result, and handle all well-known failures in a distributed environment. I feel like it is tons of work.</p>
<p>Notice that many assumptions of this paper are probably not the case in current 2021. We already have many products that support exactly-once-semantic messaging, global transactions, and so on. That will make application development easier.</p>
<p>But in certain areas, this pattern will still be useful.</p>
<p>The first use case I can think of is when the workflow is accessing multiple services&#x2F;databases. And only accessing a single service supports the atomicity. In some real-world business logics, a human can be an entity as well and can be involved in the workflow (The human interaction will usually take a very long time to process). So you have to break a global transaction into smaller transactions. I came across [7 Use Cases in 7 Minutes Each] (<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=sXGlQruUrWE">https://www.youtube.com/watch?v=sXGlQruUrWE</a>), which talks about the real use cases by using AWS SWF. AWS SWF has many similar ideas and abstractions to help application developers focus on the business logic, without worrying about workload scaling (not data scaling) and distributed failures. SWF has the concept of activity worker and workflow worker, where the activity is like a simple step of business logic, the workflow is like a decision-maker&#x2F;coordinator of different activities’ execution. Application developers just need to break the business logic into activities and workflows. All other messaging, state durability, and distributed failures are handled by SWF.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://0xc0ffee.xyz/2018/07/16/leveldb_summarize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | null">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/07/16/leveldb_summarize/" class="post-title-link" itemprop="url">Leveldb Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-07-16 10:00:00" itemprop="dateCreated datePublished" datetime="2018-07-16T10:00:00-07:00">2018-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Leveldb-简介"><a href="#Leveldb-简介" class="headerlink" title="Leveldb 简介"></a>Leveldb 简介</h3><p>Leveldb是一个单机key-value数据库library。Comparator，filter，cache，以及各种性能相关的参数都可以在创建DB的时候由参数传入。基于LSM，leveldb倾向于优化写请求，更适合写请求远大于读请求的负载。</p>
<h3 id="Leveldb-架构"><a href="#Leveldb-架构" class="headerlink" title="Leveldb 架构"></a>Leveldb 架构</h3><p>|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;DB&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|</p>
<p>|&#x3D;&#x3D;&#x3D;&#x3D;VersionSet&#x3D;&#x3D;&#x3D;&#x3D;|</p>
<p>|&#x3D;&#x3D;&#x3D;&#x3D;CurVersion&#x3D;&#x3D;&#x3D;&#x3D;||&#x3D;&#x3D;&#x3D;&#x3D;MemTable&#x3D;&#x3D;&#x3D;&#x3D;||&#x3D;&#x3D;&#x3D;&#x3D;ImmTable&#x3D;&#x3D;&#x3D;&#x3D;||&#x3D;&#x3D;&#x3D;&#x3D;WAL&#x3D;&#x3D;&#x3D;&#x3D;|</p>
<p>|&#x3D;&#x3D;&#x3D;&#x3D;TableCache&#x3D;&#x3D;&#x3D;&#x3D;||&#x3D;&#x3D;&#x3D;&#x3D;BlockCache&#x3D;&#x3D;&#x3D;&#x3D;|</p>
<p>|&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;Disk&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;|</p>
<p>Leveldb架构如上，由五六个重要的数据结构组成。DB提供用户接口，所有的存在Snapshot，Read，Write，Delete，Iterate对外接口都在这层提供。VersionSet追踪了所有SSTable的历史变动。CurVersion包含当前SSTable的索引，所有读操作访问table cache都要先经过它来定位SSTable。WAL记录写操作的oplog。MemTable使用跳表提供了快速写和无锁读特性。TableCache默认使用LRU将SSTable映射到内存中，提供快速的查找和遍历。</p>
<p>其中最中间的这层构成了整个数据库当前的视图。对于Leveldb的三种operations：</p>
<ul>
<li>Write主要涉及WAL的append，MemTable的insert</li>
<li>Read主要涉及MemTable和ImmTable的get，以及CurVersion的table find和TableCache的get</li>
<li>Compaction主要涉及ImmTable的serialize或SSTables的多路归并，和VersionSet的meta change</li>
</ul>
<h3 id="Writes-in-leveldb"><a href="#Writes-in-leveldb" class="headerlink" title="Writes in leveldb"></a>Writes in leveldb</h3><p>Leveldb的写操作包括Upsert和Delete两种类型。和其他log系统一样，写操作将操作（WriteBatch）写到log file之后就返回用户成功。后台的Compaction task负责Immtable持久化和多sstable的归并。数据同时会在内存以跳表的形式存在。</p>
<p>前台写WriteBatch会被加入FIFO，队首所在用户线程负责batch这些写请求，并通过notify其他用户线程同一批落盘的写请求的完成。这种做法降低了写请求的平均等待时间，原因如下，</p>
<ul>
<li>每次只有一个线程在写log file，这个过程不需要加锁，给新的Write请求进入队列的空隙。</li>
<li>batch write对于较小的log record连续append来说，更给有利于提高磁盘吞吐。</li>
</ul>
<p>后台Compaction对前台写有负反馈。为了保证memtable的性能，其占用内存是有软硬threshold的。当达到软threshold的时候，前台写会sleep 1秒, 以让出CPU等待immtable的Compaction。这种思路有利于避免长尾。</p>
<h3 id="Compaction-策略"><a href="#Compaction-策略" class="headerlink" title="Compaction 策略"></a>Compaction 策略</h3><p>粗略的想来，Compaction策略要能优化下面几点，</p>
<ul>
<li>Compaction的触发时机要均匀，以均摊磁盘IO，减少对前台的影响。</li>
<li>Compaction要减少上下层间的overlapp，减少对Read操作的影响。</li>
</ul>
<p>另外leveldb LSM，level越高允许的文件越多，应该是隐含了倾向于越新写的越应该置于能快速访问到的位置（可以想一下KV插入越早，其所在的层久越高，也越高概率和低层有overlap）。</p>
<p>Compaction策略每一家都不一样，这部分我没怎么看懂，进一步理解需要研究下测试方法和有没有数学形式的分析。</p>
<h3 id="Reads-in-leveldb"><a href="#Reads-in-leveldb" class="headerlink" title="Reads in leveldb"></a>Reads in leveldb</h3><p>Leveldb中的读是snapshot读。最长的读路径需要经过Memtable-&gt;ImmTable-&gt;CurVersion SSTables。每个Version视图保留了每层的SSTable Key Range，通过二分查找可以定位出Key可能所在的SSTable。之后Leveldb的做法是通过VersionSet中的TableCache的Get接口去拿到value，顺便加入新的TableCache和BlockCache Entry if possible。</p>
<h3 id="Snapshot-实现"><a href="#Snapshot-实现" class="headerlink" title="Snapshot 实现"></a>Snapshot 实现</h3><p>Leveldb支持MVCC，对外可以提供snapshot isolation。其中Version即是写请求产生的Sequence Id。用户在DB的生命周期内创建了某个SeqId的snapshot，对于DB来说，仅代表Compaction不会merge并删除该SeqId之后的sstable。</p>
<h3 id="关于Leveldb-数据安全"><a href="#关于Leveldb-数据安全" class="headerlink" title="关于Leveldb 数据安全"></a>关于Leveldb 数据安全</h3><p>涉及fdatasync和fsync的使用。POSIX说fdatasync会sync和fd相关的data和保证数据准确性的meta。我发现Leveldb使用的是fdatasync if possible。<br>要注意SyncDirIfManifest，Manifest 文件持久化了新加入的sstable并去除了多余的sstable，为了保证Manifest的data sync完成后其中记录的sstable都存在，需要在之前调用父目录的fdatasync。<br>另外unlink和rename在filesystem层不一定保序，这导致需要SetCurrentManifest在rename之后调用SyncDirIfManifest，防止redundant的sstable被删除而Manifest却没更新。</p>
<h3 id="Leveldb代码"><a href="#Leveldb代码" class="headerlink" title="Leveldb代码"></a>Leveldb代码</h3><p>Leveldb的代码比较容易理解，特别是几个抽象Memtable, VersionSets, Version, Iterator, 使整个架构很清晰。对函数调用前置条件的注释和Assertion很值得借鉴。</p>
<p>不好阅读的地方也有。VersionSets和CurrentVersion，TableCache的互相引用，DB Mutex作为参数横跨很长的调用链。这些导致我对一些细节没法很清晰的察觉，需要进一步熟悉代码才行。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://0xc0ffee.xyz/2018/04/21/raft_notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | null">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/04/21/raft_notes/" class="post-title-link" itemprop="url">RAFT Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2018-04-21 10:00:00" itemprop="dateCreated datePublished" datetime="2018-04-21T10:00:00-07:00">2018-04-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Leader-election-是如何进行的？"><a href="#Leader-election-是如何进行的？" class="headerlink" title="Leader election 是如何进行的？"></a>Leader election 是如何进行的？</h3><p>raft的leader election阶段类似使用paxos算法谋求一个共同的值(leader)。大致阶段如下：</p>
<ol>
<li>每个Proposer初始得到一个election timeout。这个election timeout是在一个范围内随机的。</li>
<li>若max election timeout超时未收到其他proposal，则向quorum发布leader是自己的proposal。</li>
<li>若得到majority acceptor认可，则成为leader。</li>
</ol>
<p>每个proposal都附带一个sequence number，在raft中称为term。term标志新一轮election的产生。算法允许不同proposer使用相同term propose the leader。</p>
<h3 id="为什么所有写操作（包括leader-election）都是majority-based？"><a href="#为什么所有写操作（包括leader-election）都是majority-based？" class="headerlink" title="为什么所有写操作（包括leader election）都是majority based？"></a>为什么所有写操作（包括leader election）都是majority based？</h3><p>A majority got newest value &#x3D;&gt; any majority group contains the newest value &#x3D;&gt; some minority group don’t have the newest value</p>
<p>Then we can choose to stop the service when there are only minority accessible. In the other hand, service can be online only when there are majoirty cab be accessible. That’s basically pigenon hole principle.</p>
<p>由于我们没法知道全局中有哪些replica含有最新的数据，是否能做leader都是通过比较判断的。如果我们有全局的信息实时记录谁有最新的数据，我们就能打破majority的限制。一些基于failure detector的协议就是这么做的。</p>
<h3 id="如何保证leader的uniqueness"><a href="#如何保证leader的uniqueness" class="headerlink" title="如何保证leader的uniqueness"></a>如何保证leader的uniqueness</h3><p>raft算法本身并不维护leader的唯一。raft只维护在相同term下只会产生一个leader。所以算法是会出现同时存在多个replica认为自己是leader的情况。</p>
<ul>
<li>对于写请求，由于只有newest term leader拥有majority的ISR，所以写请求只会在这个leader上成功。</li>
<li>对于读请求，可能读到旧值。</li>
</ul>
<p>整体上基本的raft算法能提供sequential consistency，却达不到linearizability。对于有些需求外部时间或者因果一致的应用，有的会增加了lease保证leader的uniqueness，有的在读请求上做文章，保证读的时候还是leader否则读失败。但是有得必有失，这种extension增加了算法对时间的依赖，即分布式环境中time drift对应用的影响。</p>
<h3 id="新上任的Leader什么时候可以对外服务？"><a href="#新上任的Leader什么时候可以对外服务？" class="headerlink" title="新上任的Leader什么时候可以对外服务？"></a>新上任的Leader什么时候可以对外服务？</h3><p>在raft中，成为leader并不意味这你确定所有数据已经commit，只能确定committed数据和最新数据（to-commit数据）是你的数据的子集。所以raft中新leader不能直接服务，需要经过数轮AppendEntries commit一个当前term的占位entry才行 （我有个疑问为什么必须提交一个真实的当前term的dummy entry。空的AppendEntries作为心跳也可以把之前lag的entries同步吧？虽然这样有违raft commit的原则，但是我觉得这个时候这些previous term的entries是可以commit的了）。</p>
<h3 id="谁可以commit数据？"><a href="#谁可以commit数据？" class="headerlink" title="谁可以commit数据？"></a>谁可以commit数据？</h3><p>Leader可以commit数据，不仅仅是leader with newest term。old leader可能会commit数据并告知clients。raft保证old leader的后继leader肯定会commit一遍同样的entries。最新leader也同样包含相同的entries。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://0xc0ffee.xyz/2016/06/25/storage%20note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | null">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/06/25/storage%20note/" class="post-title-link" itemprop="url">Storage Notes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2016-06-25 10:00:00" itemprop="dateCreated datePublished" datetime="2016-06-25T10:00:00-07:00">2016-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/tech/" itemprop="url" rel="index"><span itemprop="name">tech</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Storage-System-Design-Considerations"><a href="#Storage-System-Design-Considerations" class="headerlink" title="Storage System Design Considerations"></a>Storage System Design Considerations</h3><p>A storage system, used to save data, is often a fundamental service for many backend applications. Designing a storage system involves three critical considerations: <strong>Data Safety</strong>, <strong>Performance</strong>, and <strong>Availability</strong>.</p>
<h4 id="Data-Safety"><a href="#Data-Safety" class="headerlink" title="Data Safety"></a>Data Safety</h4><p>Data safety is the most important aspect in most scenarios. The system must make every effort to protect user data, as any loss of data is unacceptable.</p>
<h4 id="Availability"><a href="#Availability" class="headerlink" title="Availability"></a>Availability</h4><p>While availability may not always be an immediate concern, it remains essential for system stability. In modern storage systems, data is typically replicated across multiple nodes. If one node becomes unavailable, other nodes can handle requests. However, poor availability can lead to system instability, manifesting as increased latency or reduced throughput when alternate nodes are used.</p>
<p>One of the key factors affecting availability is the speed of stopping and restarting nodes, which impacts how quickly the system can recover from failures.</p>
<h4 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h4><p>Performance is typically measured in two dimensions: <strong>latency</strong> (how quickly a system responds) and <strong>throughput</strong> (the amount of data the system processes). Performance is the second most important consideration and is influenced by data safety and availability. Optimizing performance requires careful design choices, ranging from hardware selection to user requirements.</p>
<h5 id="Network-Interface-Card-NIC"><a href="#Network-Interface-Card-NIC" class="headerlink" title="Network Interface Card (NIC)"></a>Network Interface Card (NIC)</h5><p>The NIC is a crucial determinant of network speed, with options like 1-Gb, 10-Gb, and Infiniband affecting overall system performance. For example, with 1-Gb NICs, two approaches are commonly used for replicating data to ensure safety:</p>
<ol>
<li><strong>Star-Write</strong>: Sends all three replicas simultaneously from one node to others. This approach minimizes latency but can saturate the client’s bandwidth, reducing throughput.</li>
<li><strong>Chain-Write</strong>: Sends the first replica to one node, which then forwards it to others. This approach maximizes throughput by utilizing bandwidth across multiple nodes, but it introduces higher latency due to forwarding delays.</li>
</ol>
<p>To mitigate these challenges, <strong>two-phase commit</strong> strategies can be employed:</p>
<ul>
<li><strong>Asynchronous writes</strong>: Writes are first completed asynchronously and then retried until committed.</li>
<li><strong>Commit phase</strong>: Ensures data integrity while balancing throughput and latency.</li>
</ul>
<p>With the widespread adoption of 10-Gb NICs, Star-Write can now achieve both low latency and high throughput, especially when integrated with a two-phase commit model.</p>
<h5 id="Disk"><a href="#Disk" class="headerlink" title="Disk"></a>Disk</h5><p>Disks are the backbone of storage systems, and their configurations—such as HDD, SSD, SAS, RAID, and combinations—can significantly influence design and performance. Each choice has trade-offs in cost, speed, and durability.</p>
<h5 id="Memory-Hierarchy"><a href="#Memory-Hierarchy" class="headerlink" title="Memory Hierarchy"></a>Memory Hierarchy</h5><p>Modern computer architecture relies heavily on a memory hierarchy. Efficient use of cache significantly affects performance. Cache misses introduce latency, making locality optimization critical. </p>
<p><strong>Types of Locality</strong>:<br><strong>Spatial Locality</strong>: Improves by ensuring data close in memory is cached together.</p>
<ul>
<li>Larger cache sizes.</li>
<li>Memory indexing structures for data continuity.</li>
<li>Optimized binary layouts to improve instruction cache locality.</li>
</ul>
<p><strong>Temporal Locality</strong>: Improves by reusing data or instructions over time.</p>
<ul>
<li>Prefetching techniques.</li>
<li>Cache replacement algorithms.</li>
<li>Modular design: Breaking requests into self-contained modules connected by queues. This design enables the system to group similar operations, improving temporal locality. Advanced implementations like <strong>stagedDB</strong> ensure proper context-switching within modules, even when cache capacity is limited.</li>
</ul>
<p>At the microarchitecture level, out-of-order processors help tolerate instruction misses by executing subsequent instructions. Many of these techniques rely on accurate prediction, which is constrained by unpredictable data sets and request patterns. However, good predictions can yield substantial performance benefits.</p>
<h4 id="Stability-Requirements"><a href="#Stability-Requirements" class="headerlink" title="Stability Requirements"></a>Stability Requirements</h4><p><strong>Multitenancy</strong><br>   When multiple customers share a storage system, ensuring fairness is critical. The system may implement priority levels to safeguard high-priority requests without starving low-priority ones. Effective multitenancy involves:</p>
<ul>
<li>Fine-grained controls for individual requests.</li>
<li>End-to-end priority management across jobs and tenants.</li>
</ul>
<p><strong>Graceful Degradation</strong><br>   Graceful degradation ensures that when the system approaches maximum capacity, throughput remains steady, and latency increases proportionally. This requires the system to implement throttling mechanisms to reject excessive requests gracefully.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder"></span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Don't Drink <a href="http://0xc0ffee.xyz/">C0ffee</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
